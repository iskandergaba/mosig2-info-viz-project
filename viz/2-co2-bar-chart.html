<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<style type="text/css" media="screen, print">
		body {
			margin: 30px 50px;
			font-family: sans-serif;
		}

		.agg {
			color: crimson
		}

		.avg {
			color: steelblue
		}
	</style>
	<title>CO2 Emissions Bar Chart</title>
</head>

<body>
	<h1>CO<sub>2</sub> Emissions Bar Chart</h1>

	<button onclick="update(regions, region_emissions, region_emissions_avg)">Regions</button>
	<button onclick="update(titles, title_emissions, title_emissions_avg)">Titles</button>

	<script src="../vendor/d3/d3.js"></script>
	<script>

		var parse_time = d3.timeParse("%Y-%m-%d");
		var format_percent = d3.format('.0%');

		// set the dimensions and margins of the graph
		var margin = { top: 40, right: 80, bottom: 80, left: 80 },
			width = 960 - margin.left - margin.right,
			height = 500 - margin.top - margin.bottom;

		var x = d3.scaleBand()
			.range([0, width])
			.padding(0.2)

		var y_agg = d3.scaleLinear()
			.range([height, 0])
			.clamp(true);

		var y_avg = d3.scaleLinear()
			.range([height, 0])
			.clamp(true);

		var color = d3.scaleOrdinal()
			.range(['crimson', 'steelblue'])

		var svg = d3.select("body").append("svg")
			.attr("width", width + margin.left + margin.right)
			.attr("height", height + margin.top + margin.bottom)
			.append("g")
			.attr("transform",
				"translate(" + margin.left + "," + margin.top + ")");

		var regions, region_emissions, region_emissions_avg
		var titles, title_emissions, title_emissions_avg

		Promise.all([

			d3.tsv("../data/missions.tsv", d => ({
				mission_id: +d['#mission_id'],
				user_id: +d.user_id,
				place_id: +d.place_id,
				date: parse_time(d.date),
				duration: +d.duration,
				mode: d.mode,
				co2: +d.co2,
			})),
			d3.tsv("../data/users.tsv", d => ({
				user_id: +d['#user_id'],
				name: d.name,
				title: d.title,
				house: d.house,
				region: d.region,
				institution: d.institution,
			})),
			d3.tsv("../data/places.tsv", d => ({
				place_id: +d['#place_id'],
				distance: +d.distance,
				country: d.country,
			})),
			d3.tsv("../data/countries.tsv", d => ({
				alpha: d['#alpha2'],
				country: d.country,
				continent: d.continent,
			})),


		]).then(function (data) {

			let missions = data[0];
			let users = Object.fromEntries(data[1].map(u => [u.user_id, u]));
			let places = Object.fromEntries(data[2].map(p => [p.place_id, p]));
			let countries = Object.fromEntries(data[3].map(c => [c.alpha, c]));

			let houses = Object.keys(Object.fromEntries(data[1].map(u => [u.house])));
			regions = Object.keys(Object.fromEntries(data[1].map(u => [u.region])));
			titles = Object.keys(Object.fromEntries(data[1].map(u => [u.title])));

			// emission per user

			let emissions = Object.fromEntries(Object.keys(users).map(u_id => [u_id, 0]));

			let house_count = Object.fromEntries(houses.map(house => [house, 0]));
			let house_emissions = Object.fromEntries(houses.map(house => [house, 0]));
			let region_count = Object.fromEntries(regions.map(region => [region, 0]));
			region_emissions = Object.fromEntries(regions.map(region => [region, 0]));
			let title_count = Object.fromEntries(titles.map(title => [title, 0]));
			title_emissions = Object.fromEntries(titles.map(title => [title, 0]));

			for (let mission of missions) {
				house_count[users[mission.user_id].house]++
				house_emissions[users[mission.user_id].house] += mission.co2 * places[mission.place_id].distance / 1000; // tons of CO2
				region_count[users[mission.user_id].region]++
				region_emissions[users[mission.user_id].region] += mission.co2 * places[mission.place_id].distance / 1000; // tons of CO2
				title_count[users[mission.user_id].title]++
				title_emissions[users[mission.user_id].title] += mission.co2 * places[mission.place_id].distance / 1000; // tons of CO2
			}

			region_emissions_avg = Object.fromEntries(regions.map(region => [region, 0]));
			for (let k in regions) {
				region = regions[k]
				region_emissions_avg[region] = 1000 * region_emissions[region] / region_count[region]
			}

			title_emissions_avg = Object.fromEntries(titles.map(title => [title, 0]));
			for (let k in titles) {
				title = titles[k]
				title_emissions_avg[title] = 1000 * title_emissions[title] / title_count[title]
			}
			
			//update(regions, region_emissions, region_emissions_avg)
			update(titles, title_emissions, title_emissions_avg)
		});

		function update(categories, data, data_avg) {
			// Scale the range of the data in the domains
			let subgroups = ['aggregate', 'average']
			x.domain(categories);
			y_agg.domain([0, d3.max(Object.values(data))]);
			y_avg.domain([0, d3.max(Object.values(data_avg))]);
			color.domain(subgroups)

			var x_sub = d3.scaleBand()
				.domain(subgroups)
				.range([0, x.bandwidth()])
				.padding(0.05)

			var ys = { aggregate: y_agg, average: y_avg }

			var data = categories.map(k => ({
				category: k,
				aggregate: data[k],
				average: data_avg[k]
			}));

			// Show the bars
			var bars = svg.append("g")
				.selectAll("g")
				.data(data)
				// Enter in data = loop group per group
				.enter()
				.append("g")
				.attr("transform", function (d) { return "translate(" + x(d.category) + ",0)"; })
				.selectAll("rect")
			bars.data(function (d) { return subgroups.map(function (key) { return { key: key, value: d[key] }; }); })
				.enter().append("rect")
				.merge(bars)
				.transition()
				.duration(750)
				.attr("x", function (d) { return x_sub(d.key); })
				.attr("y", function (d) { return ys[d.key](d.value); })
				.attr("width", x_sub.bandwidth())
				.attr("height", function (d) { return height - ys[d.key](d.value); })
				.attr("fill", function (d) { return color(d.key); });

			bars = bars
				.exit()
				.remove()

			// add the x Axis
			svg.append("g")
				.attr("transform", "translate(0," + height + ")")
				.transition().duration(1000)
				.call(d3.axisBottom(x).tickSize(0));
			svg.append("text")
				.attr("text-anchor", "end")
				.attr("x", width / 2 + 50)
				.attr("y", height + margin.top)
				.text("Titles");

			// add the y_agg Axis
			svg.append("g")
				.attr('class', 'agg')
				.transition().duration(1000)
				.call(d3.axisLeft(y_agg));
			svg.append("text")
				.attr("text-anchor", "end")
				.attr("transform", "rotate(-90)")
				.attr("y", -margin.left + 40)
				.attr("x", -margin.top)
				.text("Total Emissions (Tons)")

			// add the y_avg Axis
			svg.append("g")
				.attr('class', 'avg')
				.attr("transform", "translate( " + width + ", 0 )")
				.transition().duration(1000)
				.call(d3.axisRight(y_avg));
			svg.append("text")
				.attr("text-anchor", "end")
				.attr("transform", "rotate(-90)")
				.attr("y", width + 50)
				.attr("x", -margin.top)
				.html("Avg. Emissions (Kg)")
		}
	</script>
</body>

</html>